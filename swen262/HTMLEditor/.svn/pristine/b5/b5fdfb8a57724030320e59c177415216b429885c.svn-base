package main;

import static java.awt.event.InputEvent.CTRL_DOWN_MASK;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.util.LinkedList;

import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JMenu;
import javax.swing.JMenuBar;
import javax.swing.JMenuItem;
import javax.swing.JTabbedPane;
import javax.swing.KeyStroke;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;
import javax.swing.filechooser.FileNameExtensionFilter;

@SuppressWarnings("serial")
public class Display extends JFrame{
	
	public static Display display = null;
 
	//CommandCenter command;
	JTabbedPane tabs;
	JFileChooser chooser;
	LinkedList<Tab> tabList;
	int tab_index;
	
	protected Display(){
		setTitle("HTML Editor");
		setSize(750, 750);
		chooser = new JFileChooser();
		tabList = new LinkedList<Tab>();
		//command = new CommandCenter();
		init();
		tab_index = 0;
	}
	
	public static Display getDisplay(){
		if(display == null){
			display = new Display();
		}
		return display;
	}
	
	
	public void init(){
		createMenuBar();
		createTabbedPanes();
	}
	
	private void createTabbedPanes() {
		tabs = new JTabbedPane();
		
		Tab newTab = new Tab(0);
		
		tabList.add(newTab);
		
		tabs.addTab(null, newTab.getContent() );
		tabs.setTabComponentAt( tab_index , newTab.getHeader() );
		
		
		
		tabs.addTab("+",null);
		tabs.setSelectedIndex( 0 );
		tabs.addChangeListener( new ChangeListener(){
            @Override
            public void stateChanged(ChangeEvent arg0) {
            	tab_index = Display.this.tabs.getSelectedIndex();
            	//System.out.println(Display.this.tab_index);
                int tabCount = Display.this.tabs.getTabCount();
                if(Display.this.tab_index == tabCount - 1){
                    System.out.println("DEBUG: Triggered state change");
                    Display.this.tabs.setSelectedIndex(0);
                    Tab newTab = new Tab(tabCount - 1);
                    tabList.add(newTab);
                    Display.this.tabs.insertTab(null, null, newTab.getContent(), null, tabCount - 1);
                    Display.this.tabs.setTabComponentAt(tabCount - 1, newTab.getHeader());
                    
                    Display.this.tabs.setSelectedIndex( tabCount - 1 );
                    
                   
                    
                }
            }
        } );
		this.add(tabs);
	}

	//basic menu bar
	private void createMenuBar(){
		JMenuBar menu = new JMenuBar();
		JMenu file = new JMenu("File");
		JMenu insert = new JMenu("Insert");
		JMenuItem open = new JMenuItem("Open");
		JMenuItem save = new JMenuItem("Save");
		JMenuItem exit = new JMenuItem("Exit");
		
		//short-cut exit key
		exit.setAccelerator(KeyStroke.getKeyStroke('E', CTRL_DOWN_MASK));
		open.setAccelerator(KeyStroke.getKeyStroke('O', CTRL_DOWN_MASK));
		save.setAccelerator(KeyStroke.getKeyStroke('S', CTRL_DOWN_MASK));
		
		
		
		open.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent event){
				FileNameExtensionFilter filter = new FileNameExtensionFilter("HTML Files", "html");
				chooser.setFileFilter(filter);
				
				int returnVal = chooser.showOpenDialog(tabs);
				if(returnVal == JFileChooser.APPROVE_OPTION){
					File file = chooser.getSelectedFile();
					String inputFile = file.getPath();
					FileReader filereader;
					BufferedReader br = null;
					
					try{
						filereader = new FileReader(inputFile);
						br = new BufferedReader(filereader);
					} catch (FileNotFoundException e){
						e.printStackTrace();
					}
					
					try{
						String line;
						while(((line = br.readLine()) != null)){
							Line curr = new Line(line);
							//stores data in current buffer's data structure
							((TabContent) tabs.getComponentAt(tab_index)).getBuffer().add(curr);
						}
						((TabContent) tabs.getComponentAt(tab_index)).getBuffer().updateTextArea();
					} catch (IOException e){
						e.printStackTrace();
					}
					
				} else {
					System.out.println("Open terminated");
				}
			}
		});
		
		save.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent event){
	                JFileChooser saveFile = new JFileChooser();
	                saveFile.showSaveDialog(null);
	            }
		});
		
		exit.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent event){
				System.exit(0); //exit editor
			}
		});
		
		file.add(open);
		file.add(save);
		file.add(exit);
		menu.add(file);
		menu.add(insert);
		setJMenuBar(menu);
	}
	
	public JTabbedPane getTabPane(){
		return this.tabs;
	}
	
	public LinkedList<Tab> getTabList(){
		return this.tabList;
	}
	
	public static int antiNegativeOne(int val){
	    if (val == -1){
	        val = 0;
	    }
	    return val;
	}
}